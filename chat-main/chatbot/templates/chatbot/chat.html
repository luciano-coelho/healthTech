{% extends 'base.html' %} {% block main%}
{% load static %}

<!-- Modal da proposta -->
<div class="modal fade" id="proposalModal" tabindex="-1" role="dialog" aria-labelledby="proposalModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content p-5">
      <div class="modal-header">
        <h5 class="modal-title" id="proposalModalLabel">
          Proposta de Treinamento
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h5>Data</h5>
        <p id="proposalDate"></p>

        <h5>Destinatário</h5>
        <p id="proposalRecipient"></p>

        <h5>Cliente</h5>
        <p id="proposalClient"></p>

        <h5>Título</h5>
        <p id="proposalTitle"></p>

        <h5>Objetivo</h5>
        <p id="proposalObjective"></p>

        <h5>Período de Realização</h5>
        <p id="proposalPeriod"></p>

        <h5>Detalhamento da Proposta</h5>
        <div id="proposalDetails"></div>

        <h5>Carga Horária Total</h5>
        <p id="proposalTotalHours"></p>

        <h5>Valor do Investimento</h5>
        <p id="proposalInvestment"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal editar proposta -->
<div class="modal fade" id="editproposalModal" tabindex="-1" role="dialog" aria-labelledby="editproposalModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content p-5">
      <div class="modal-header">
        <h5 class="modal-title" id="proposalModalLabel">Proposta de Treinamento</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Inputs fixos -->
        <h5>Data</h5>
        <div class="input-group mb-3">
          <input class="form-control" type="text" id="inputproposalDate" />
          <div class="input-group-append">
            <button disabled class="btn btn-outline-secondary" type="button" title="Gerar novamente"
              onclick="generateNewValue('inputproposalDate', this)"><i
                class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>

        <h5>Destinatário</h5>
        <div class="input-group mb-3">
          <input class="form-control" type="text" id="inputproposalRecipient" />
          <div class="input-group-append">
            <button disabled class="btn btn-outline-secondary" type="button" title="Gerar novamente"
              onclick="generateNewValue('inputproposalRecipient', this)"><i
                class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>

        <h5>Cliente</h5>
        <div class="input-group mb-3">
          <input class="form-control" type="text" id="inputproposalClient" />
          <div class="input-group-append">
            <button disabled class="btn btn-outline-secondary" type="button" title="Gerar novamente"
              onclick="generateNewValue('inputproposalClient', this)"><i
                class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>

        <h5>Título</h5>
        <div class="input-group mb-3">
          <input class="form-control" type="text" id="inputproposalTitle" />
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" title="Gerar novamente"
              onclick="generateNewValue('inputproposalTitle', this)"><i
                class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>

        <h5>Objetivo</h5>
        <div class="input-group mb-3">
          <input class="form-control" type="text" id="inputproposalObjective" />
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" title="Gerar novamente"
              onclick="generateNewValue('inputproposalObjective', this)"><i
                class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>

        <h5>Período de Realização</h5>
        <div class="input-group mb-3">
          <input class="form-control" type="text" id="inputproposalPeriod" />
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" title="Gerar novamente"
              onclick="generateNewValue('inputproposalPeriod', this)"><i
                class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>

        <!-- Detalhamento da Proposta -->
        <h5>Detalhamento da Proposta</h5>
        <div id="inputproposalDetails"></div>


        <h5>Valor do Investimento</h5>
        <div class="input-group mb-3">
          <input class="form-control" type="text" id="inputproposalInvestment" />
          <div class="input-group-append">
            <button disabled class="btn btn-outline-secondary" type="button" title="Gerar novamente"
              onclick="generateNewValue('inputproposalInvestment', this)"><i
                class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        <button type="button" id="saveProposal" class="btn btn-success" data-dismiss="modal">Salvar</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="chat-box" id="chatbox">
    <div class="chat-message bot">
      <div class="bot-img"></div>
      <div class="message d-inline">
        <h3>Bem-vindo à GenIA, sua assistente de propostas corporativas!</h3>
        <p>
          Estou aqui para ajudar no processo de criação da sua proposta
          corporativa. Antes de começarmos, preciso de algumas informações
          importantes. Podemos começar?
        </p>
        <button class="btn btn-primary" id="start">Iniciar Proposta</button>
      </div>
    </div>
  </div>
  <div class="input-group my-2 p-2">
    <input type="text" class="form-control" placeholder="Digite sua mensagem" id="message" disabled />

    <div class="input-group-append">
      <button class="btn btn-primary" type="button" id="send" disabled>
        Enviar
      </button>
    </div>
  </div>
</div>





<!-- AJUDA -->

<!-- Ícone de Ajuda -->
<div class="help-icon-container" onclick="openModal()">
  <img src="{% static 'img/GenIA-person.png' %}" alt="Ajuda" id="help-icon">
  <div class="help-message">
    Olá, eu sou a GenIA. Precisa de ajuda?<br> Clique e visite nossa área de Perguntas Frequentes.
  </div>
</div>

<!-- Modal -->
<div id="myModal" class="modal">
  <div class="modal-content-help">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Perguntas Frequentes</h2>
    <div class="faq-section">
      <div class="faq-question" onclick="toggleAnswer(this)">Como criar propostas corporativas utilizando a GenIA?</div>
      <div class="faq-answer">A criação é simples e intuitiva. Basta seguir as orientações apresentadas no chat e
        responder de forma clara e correta. Se precisar editar algum campo, deixe para fazer no final, ao visualizar a
        proposta para conferência.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">É possível criar propostas com base em respostas anteriores
        do cliente?</div>
      <div class="faq-answer">Sim. Se o cliente preencheu corretamente o formulário de "Solicitação de Proposta", você
        pode complementar as informações necessárias e gerar uma proposta a partir disso. Essa funcionalidade está
        disponível no menu "Solicitação de Propostas".</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Posso editar uma proposta gerada pelo sistema?</div>
      <div class="faq-answer">Após a geração da proposta, você terá a opção de visualizá-la. Nesse momento, será
        possível editar partes específicas da proposta. No entanto, após o documento ser exportado para o formato Word,
        não será mais possível realizar edições. Se precisar fazer alterações, será necessário gerar uma nova proposta.
      </div>

      <div class="faq-question" onclick="toggleAnswer(this)">Criação de Múltiplas Propostas</div>
      <div class="faq-answer">Não é possível gerar múltiplas propostas simultaneamente. As propostas devem ser criadas
        uma de cada vez.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Acesso ao Histórico de Propostas</div>
      <div class="faq-answer">Todas as propostas geradas são automaticamente enviadas para o seu e-mail registrado no
        sistema logo após serem exportadas para o formato Word. O NAF da sua unidade também recebe uma cópia dessa
        proposta.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Alteração de Informações do Perfil</div>
      <div class="faq-answer">Apenas o NAF da sua unidade tem permissão para editar as informações do seu perfil de
        usuário.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Adição de Novos Usuários ou Professores</div>
      <div class="faq-answer">A adição de usuários ou professores no sistema é realizada exclusivamente pelo NAF da sua
        unidade.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Segurança das Propostas</div>
      <div class="faq-answer">As propostas são geradas em um ambiente seguro e criptografado. Apenas o usuário que criou
        a proposta, seu superior imediato, e o NAF da unidade têm acesso às cópias dessas propostas.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Quem Pode Acessar as Propostas</div>
      <div class="faq-answer">As propostas são acessíveis pelo usuário que as gerou, seu superior imediato, e o NAF da
        sua unidade.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Como navegar entre diferentes funcionalidades do sistema?
      </div>
      <div class="faq-answer">A aplicação conta com apenas o menu superior com todas as funcionalidades da aplicação e
        uma opção de ajuda clicando no ícone da GenIA.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Funções Principais da GenIA</div>
      <div class="faq-answer">A GenIA é projetada para gerar propostas corporativas utilizando inteligência artificial.
      </div>

      <div class="faq-question" onclick="toggleAnswer(this)">Formatos de Exportação Disponíveis</div>
      <div class="faq-answer">As propostas geradas pelo sistema são exportadas exclusivamente em formato Word.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Tipos de Documentos Gerados</div>
      <div class="faq-answer">A inteligência artificial da GenIA foi especificamente treinada para a criação de
        propostas corporativas.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Confirmação de Envio de Propostas</div>
      <div class="faq-answer">Para garantir que sua proposta foi enviada com sucesso, verifique se recebeu a proposta no
        seu e-mail e se o download do arquivo foi realizado corretamente.</div>

      <div class="faq-question" onclick="toggleAnswer(this)">Recuperação de Senha</div>
      <div class="faq-answer">Na página inicial, abaixo do botão "Entrar", você encontrará a opção "Esqueceu a Senha?"
        para solicitar a redefinição de senha. Se tiver dificuldades, por favor, entre em contato com o NAF (Núcleo de
        Apoio ao Funcionário) da sua unidade para obter um novo acesso.</div>
    </div>
  </div>
</div>


<script>

  async function generateNewValue(inputId, button) {


    var actualValue = document.getElementById(inputId)


    const originalText = button.innerHTML;
    button.disabled = true;


    try {
      // Faz o post e espera a resposta do servidor
      let data = await $.post("{% url 'send_message' %}", {
        'message': `Sabendo que a proposta foi ${proposal}, gere um novo valor, mantendo sentido a resposta anterior substituindo apenas o item ${actualValue.value}. A resposta dever ter a estrutura: {"newValue":""}`,
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      });

      console.log(data.response);
      
      // Depois que a resposta chegar, atualize o valor
      actualValue.value = JSON.parse(data.response)['newValue'];
      console.log(actualValue.value);
    } catch (error) {
      console.error('Erro ao gerar o novo valor:', error);
    } finally {
      // Retira o estado de loading e restaura o botão
      button.innerHTML = originalText;
      button.disabled = false;
    }





  }

  // AJUDA

  // Função para adicionar a classe de animação
  function blinkIcon() {
    const icon = document.getElementById('help-icon');
    icon.classList.add('blink');

    // Remove a animação após completá-la
    setTimeout(() => {
      icon.classList.remove('blink');
    }, 3000); // 3000ms = 3s para 6 ciclos de 0.5s cada
  }

  // Chama a função a cada 5 minutos (300000ms)
  setInterval(blinkIcon, 300000);

  // Funções para abrir e fechar o modal
  function openModal() {
    document.getElementById("myModal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("myModal").style.display = "none";
  }

  // Função para expandir/colapsar a resposta
  function toggleAnswer(element) {
    const answer = element.nextElementSibling;
    if (answer.style.display === "block") {
      answer.style.display = "none";
    } else {
      answer.style.display = "block";
    }
  }





  var total_hours = 0; 
  var prompText = ''
  var proposal;
  var response = [];
  var inputproposalDetails = document.getElementById('inputproposalDetails');
  var currentQuestion = 0;
  $(document).ready(function () {
    var questions = [
      {% for question in array_questions %}
                  "{{ question.question }}",
    {% endfor %}
          ];

  function askQuestion() {
    $('#options').remove();
    if (currentQuestion < questions.length) {
      $('#chatbox').append(`
                      <div class="chat-message bot">
                          <div class="bot-img"></div>
                          <div class="message">
                              ${questions[currentQuestion]}
                              <div id="options" class="options"></div>
                          </div>
                      </div>
                  `);

      if (currentQuestion === 2 || currentQuestion === 3) {
        $('#message').prop('disabled', true);
        $('#send').prop('disabled', true);
        createOptions();
      } else if (currentQuestion === 4) {
        $('#message').prop('disabled', false);
        $('#send').prop('disabled', false);
        createOptions();
      } else if (currentQuestion === 6) {
        $('#message').prop('disabled', true);
        $('#send').prop('disabled', true);
        createOptions();
      } else if (currentQuestion === 8) {
        $('#message').prop('disabled', true);
        $('#send').prop('disabled', true);
        createOptions();
      } else if (currentQuestion === 10) {
        $('#message').prop('disabled', true);
        $('#send').prop('disabled', true);
        createOptions();
      } else {
        $('#message').prop('disabled', false);
        $('#send').prop('disabled', false);
        $('#options').empty();
      }
      var chatBox = document.getElementById('chatbox');
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  }

  function createOptions() {
    var options = [];
    if (currentQuestion === 2) {
      options = ["Público", "Privado"];
    } else if (currentQuestion === 3) {
      options = ["Ação extensiva", "Curso", "Consultoria"];
    } else if (currentQuestion === 4) {
      options = ["Gerar Automaticamente"];
    } else if (currentQuestion === 6) {
      options = ["Sim", "Não"];
    } else if (currentQuestion === 8) {
      options = ["Sim", "Não"];
    } else if (currentQuestion === 10) {
      options = ["Sim", "Não"];
    }
    var optionsHtml = '';
    options.forEach(function (option) {
      optionsHtml += `<div class="option-card"><div class="card-body">${option}</div></div>`;
    });
    $('#options').html(optionsHtml);

    $('.option-card').click(function () {
      var selectedOption = $(this).text();
      $('#chatbox').append('<div class="chat-message user"><div class="message">' + selectedOption + '</div></div>');

      if (selectedOption == "Não" && currentQuestion == 6) {
        response.push(selectedOption == "Não" ? 'Sem carga horária' : selectedOption);
        currentQuestion++
      }
      else if (selectedOption == "Não" && currentQuestion == 8) {
        currentQuestion++
        response.push(selectedOption == "Não" ? 'Sem atribuição' : selectedOption);
      }
      else if (selectedOption == "Não" && currentQuestion == 10) {
        response.push(selectedOption == "Não" ? 'Sem atribuição' : selectedOption);
        currentQuestion++
        sendMessage()
      }

      response.push(selectedOption == "Não" ? '' : selectedOption);
      $('#options').empty();
      currentQuestion++;
      console.log(currentQuestion);


      askQuestion();
    });
  }

  $('#start').click(function () {
    $('#message').prop('disabled', false);
    $('#send').prop('disabled', false);
    $(this).hide();
    askQuestion();
  });

  $('#send').click(function () {
    sendMessage();
  });

  $('#message').keypress(function (event) {
    if (event.which == 13) {
      sendMessage();
      event.preventDefault();
      var chatBox = document.getElementById('chatbox');
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  });





  $(document).on('click', '#viewProposalBtn', function () {
    $('#proposalDate').text(JSON.parse(proposal).data);
    $('#proposalRecipient').text(JSON.parse(proposal).destinatario);
    $('#proposalClient').text(JSON.parse(proposal).cliente);
    $('#proposalTitle').text(JSON.parse(proposal).titulo);
    $('#proposalObjective').text(JSON.parse(proposal).objetivo);
    $('#proposalPeriod').text(JSON.parse(proposal).periodo);

    var proposalDetailsHtml = `
              <table class="table table-bordered">
                  <thead>
                      <tr>
                          <th>Título da Etapa</th>
                          <th>Carga Horária</th>
                          <th>Público Alvo</th>
                          <th>Objetivo da Etapa</th>
                          <th>Conteúdo Programático</th>
                      </tr>
                  </thead>
                  <tbody>
          `;

    JSON.parse(proposal).detalhamento_proposta.forEach(function (etapa) {
      proposalDetailsHtml += `
                  <tr>
                      <td>${etapa.titulo_etapa}</td>
                      <td>${etapa.carga_horaria_necessaria}</td>
                      <td>${etapa.publico_alvo}</td>
                      <td>${etapa.objetivo_da_etapa}</td>
                      <td>
                              ${etapa.conteudo_programatico.map(conteudo => `<li>${conteudo}</li>`).join('')}
                      </td>
                  </tr>
              `;
    });

    proposalDetailsHtml += `
            </tbody>
        </table>
    `;

    $('#proposalDetails').html(proposalDetailsHtml);

    $('#proposalTotalHours').text(JSON.parse(proposal).carga_horaria_total);
    $('#proposalInvestment').text(JSON.parse(proposal).valor_investimento);
  })

  $(document).on('click', '#editProposalBtn', function () {
    inputproposalDetails.innerHTML = ""

    $('#inputproposalDate').val(JSON.parse(proposal).data);
    $('#inputproposalRecipient').val(JSON.parse(proposal).destinatario);
    $('#inputproposalClient').val(JSON.parse(proposal).cliente);
    $('#inputproposalTitle').val(JSON.parse(proposal).titulo);
    $('#inputproposalObjective').val(JSON.parse(proposal).objetivo);
    $('#inputproposalPeriod').val(JSON.parse(proposal).periodo);
    $('#inputproposalTotalHours').val(JSON.parse(proposal).carga_horaria_total);
    $('#inputproposalInvestment').val(JSON.parse(proposal).valor_investimento);

    JSON.parse(proposal).detalhamento_proposta.forEach((item, indexDetalhamento) => {


      inputproposalDetails.innerHTML += `
            <hr>

            

        <h6>${indexDetalhamento + 1}. Título da etapa</h5>
        <div class="input-group mb-3">
          <input class="form-control" value="${item.titulo_etapa}" type="text" id="inputTitle_${indexDetalhamento}">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" title="Gerar novamente" onclick="generateNewValue('inputTitle_${indexDetalhamento}', this)"><i class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>
        <h6>${indexDetalhamento + 1}. Carga Horária</h5>
        <div class="input-group mb-3">
          <input class="form-control sum" value="${item.carga_horaria_necessaria}" type="text" id="inputHours_${indexDetalhamento}">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" title="Gerar novamente" onclick="generateNewValue('inputHours_${indexDetalhamento}', this)"><i class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>
        <h6>${indexDetalhamento + 1}. Público Alvo</h5>
        <div class="input-group mb-3">
          <input class="form-control" value="${item.publico_alvo}" type="text" id="inputAudience_${indexDetalhamento}">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" title="Gerar novamente" onclick="generateNewValue('inputAudience_${indexDetalhamento}', this)"><i class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>
        <h6>${indexDetalhamento + 1}. Objetivo da Etapa</h5>
        <div class="input-group mb-3">
          <input class="form-control" value="${item.objetivo_da_etapa}" type="text" id="inputObjective_${indexDetalhamento}">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" title="Gerar novamente" onclick="generateNewValue('inputObjective_${indexDetalhamento}', this)"><i class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>
        <h6>${indexDetalhamento + 1}.Conteúdo Programático</h5>
              


            ${item.conteudo_programatico.map((conteudo, index) => `<div class="input-group mb-3">
          <input class="form-control" value="${conteudo}" type="text" id="inputcontent_${indexDetalhamento}_${index}">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" title="Gerar novamente" onclick="generateNewValue('inputcontent_${indexDetalhamento}_${index}', this)"><i class="fa-solid fa-list-check text-white"></i></button>
          </div>
        </div>`).join('')}

            `

    });


  });



  $(document).on('click', '#saveProposal', function () {

    total_hours = 0

    document.querySelectorAll('.sum').forEach((item)=>{
      total_hours += parseInt(item.value)
      console.log(total_hours);
    })

    var updatedProposal = {
      data: $('#inputproposalDate').val(),
      destinatario: $('#inputproposalRecipient').val(),
      cliente: $('#inputproposalClient').val(),
      titulo: $('#inputproposalTitle').val(),
      objetivo: $('#inputproposalObjective').val(),
      periodo: $('#inputproposalPeriod').val(),
      carga_horaria_total: `${total_hours} horas`,
      valor_investimento: $('#inputproposalInvestment').val(),
      type: (response[2] == "Público") ? "public" : "private",
      atribuicao_senac:response[9],
      atribuicao_cliente:response[11],
      detalhamento_proposta: JSON.parse(proposal).detalhamento_proposta.map((item, index) => {
        return {
          titulo_etapa: $(`#inputTitle_${index}`).val(),
          carga_horaria_necessaria: $(`#inputHours_${index}`).val(),
          publico_alvo: $(`#inputAudience_${index}`).val(),
          objetivo_da_etapa: $(`#inputObjective_${index}`).val(),
          conteudo_programatico: [
            item.conteudo_programatico.map((el, num) => $(`#inputcontent_${index}_${num}`).val())
          ].toString().split(",")
        }
      })

    };


    proposal = JSON.stringify(updatedProposal)
  })





  $(document).on('click', '#exportProposalBtn', function () {

    $.ajax({
      url: "{% url 'download_doc' %}",
      type: "POST",
      data: {
        'proposal': proposal,
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      },
      xhrFields: {
        responseType: 'blob'
      },
      success: function (blob) {
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'proposta.doc';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        console.log('Download gerado com sucesso.');

        $('.chat-message.bot:last-child .message').html(`
            <div class="container container-options d-flex">
                      <div id="viewProposalBtn">
                          <button class="card-body btn-options" type="button" data-toggle="modal" data-target="#proposalModal">Visualizar proposta</button>
                      </div>
                      <div id="editProposalBtn">
                          <button class="card-body btn-options" type="button" data-toggle="modal" data-target="#editproposalModal">Editar proposta</button>
                      </div>
                      <div id="exportProposalBtn">
                          <button class="card-body btn-options">Exportar Proposta</button>
                      </div>
                      <div  onclick="location.reload()">
                          <button class="card-body btn-info btn-options">Nova Proposta</button>
                      </div>
              </div>
        `)

        
      },
      error: function (xhr, status, error) {
        console.log(`Erro: ${error}`);
      }
    });
  });





  window.getResponse = function (prompt, attempts = 0) {

    // console.log(prompt);


    // Limite máximo de tentativas
    const maxAttempts = 5;

    $.post("{% url 'send_message' %}", {
      'message': prompt,
      'csrfmiddlewaretoken': '{{ csrf_token }}'
    }, function (data) {

      try {

        proposal = data.response;
        console.log(JSON.parse(proposal))
        JSON.parse(proposal)
        JSON.stringify(proposal)
        var optionsHtml = `
                  <div class="container container-options d-flex">
                      <div id="viewProposalBtn">
                          <button class="card-body btn-options" type="button" data-toggle="modal" data-target="#proposalModal">Visualizar proposta</button>
                      </div>
                      <div id="editProposalBtn">
                          <button class="card-body btn-options" type="button" data-toggle="modal" data-target="#editproposalModal">Editar proposta</button>
                      </div>
                      <div id="exportProposalBtn">
                          <button class="card-body btn-options">Exportar Proposta</button>
                      </div>
                  </div>
              `;
        $('.chat-message.bot:last-child .message').html(optionsHtml);
        var chatBox = document.getElementById('chatbox');
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (e) {
        console.error("Erro de parse:", e);
        if (attempts < maxAttempts) {
          getResponse(prompt, attempts + 1);
        } else {
          console.error("Número máximo de tentativas alcançado.");
          var optionsHtml = `
                  <div class="container d-flex">
                      <div class="option-card">
                          <button onclick="window.location.reload()" class="card-body btn btn-info">Atualize a página e tente novamente.</button>
                      </div>
                  </div>
              `;
          $('.chat-message.bot:last-child .message').html(optionsHtml);

          var chatBox = document.getElementById('chatbox');
          chatBox.scrollTop = chatBox.scrollHeight;
          // Aqui você pode adicionar um fallback ou mostrar uma mensagem de erro ao usuário
        }
      }
    });
  }






  function sendMessage() {


    var message = $('#message').val();
    response.push(message);
    message ? $('#chatbox').append('<div class="chat-message user"><div class="message">' + message + '</div></div>') : '';
    $('#message').val('');



    if (currentQuestion < questions.length - 1) {
      currentQuestion++;
      if (message.trim() === '') return;
      askQuestion();
    } else {
      console.log(response);

      $('#message').prop('disabled', true);
      $('#send').prop('disabled', true);
      prompText = `
                  Crie uma proposta de treinamento profissional e abrangente para a prestação de serviços ou produtos a um cliente com o nome ${response[1]}.
                  A proposta deve se basear nos seguintes parametros (IMPORTANTE: Nenhum parametro pode ser retornado vazio):
                  destinatário:${response[0]}
                  titulo: ${response[4]}(Não utilizar os termos a seguir no titulo "Qualificação Profissional, Técnico, Graduação ou Pós-Graduação")
                  Objetivo:${response[5]}(essa etapa precisa ser detalhada em um parágrafo, utilizando o resumo informado. Importante utilizar um ou mais verbos a seguir para dar enfase no objetivo: difundir, divulgar, propagar, repassar, orientar, apresentar,aprimorar, melhorar, otimizar, complementar,
                  ampliar, potencializar, acrescentar, amplificar, aumentar, incrementar, práticar ,levantar, mapear, atuar, realizar)
                  Periodo de realização:{}(gerar com base na proposta)
                  Detalhamento da proposta: Essa etapa precisa ser detalhada levando em consideração o titulo e objetivo.
                  Importante!!! - O detalhamento da proposta deve ser dividido em etapas de dependendo da carga horaria e também utilizar a seguinte estrura: Titulo da etapa, carga horaria necessária, público alvo, objetivo da etapa, conteudo programatico(em lista)
                  Carga horária total: {}
                  Valor do investimento: {}
                  Importante que a resposta seja um objeto json sem as ""json"". O json deve sempre conter as seguinte estrurtura de  chaves:
                  "data": "${new Date().toLocaleDateString()}",
                  "cliente": "",
                  "destinatario": "",
                  "titulo": "",
                  "objetivo": "",
                  "periodo": "",
                  "detalhamento_proposta": [
                      {
                          "titulo_etapa": "",
                          "carga_horaria_necessaria": "",
                          "publico_alvo": "",
                          "objetivo_da_etapa": "",
                          "conteudo_programatico": [
                          ]
                      },
                  ],
                  "carga_horaria_total": "${response[7]} Horas (Esse valor deve ser sempre a soma de todas as horas da carga_horaria_necessaria)",
                  "valor_investimento": "",
                  "type": "${(response[2] == "Público") ? "public" : "private"}",
                  "atribuicao_senac": "${(response[8] == "Sem atribuição") ? "Sem atribuição" : response[9]}",
                  "atribuicao_cliente": "${(response[10] == "Sem atribuição") ? "Sem atribuição" : response[11]}"
                  
  }
                  `;


      $('#chatbox').append('<div class="chat-message bot"><div class="bot-img"></div><div class="message">Gerando Proposta...</div></div>');


      getResponse(prompText)

    }
  }

      });
</script>

{% endblock %}