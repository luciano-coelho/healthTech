{% extends 'base.html' %}
{% load reconciliation_extras %}
{% load static %}

{% block main %}
<div class="container recon-container mt-4" data-previsao="{{ previsao_pagamento|default:'' }}">
  <div class="d-flex align-items-center justify-content-between mb-1">
    <h5 class="mb-0">Demonstrativo: {{ repasse_numero }} - {{ competencia }}</h5>
    <div class="d-flex align-items-center" style="gap:8px;">
      <a href="{% url 'upload_remittance' %}" class="btn btn-outline-secondary btn-sm">Voltar ao upload</a>
      <button type="button" class="btn btn-primary btn-sm" id="open-dashboard">Dashboard</button>
      <button type="button" class="btn btn-outline-primary btn-sm" id="open-reconcile">Conciliar Preços</button>
    </div>
  </div>
  <p class="text-muted mb-3"><strong>Terceiro:</strong> {{ terceiro_nome }} | <strong>CNPJ:</strong> {{ cnpj }} | <strong>Previsão:</strong> {{ previsao_pagamento }}</p>

  {% if summary_all %}
  <h5 class="mt-2 mb-2">Consolidado geral</h5>
  <div class="mb-4">
    <div class="border rounded p-3" style="background:#fff; border-color:#e0e0e0;">
      <div class="d-flex justify-content-between flex-wrap" style="gap:24px">
        <div>
          <div class="text-muted">Itens (consolidado)</div>
          <div class="h5 mb-0 text-dark font-weight-bold">{{ summary_all.count }}</div>
        </div>
        <div>
          <div class="text-muted">Qtd total</div>
          <div class="h5 mb-0 text-dark font-weight-bold">{{ summary_all.total_qtd|default:'0' }}</div>
        </div>
        <div>
          <div class="text-muted">Bruto</div>
          <div class="h5 mb-0 text-dark font-weight-bold">{{ summary_all.bruto|brl }}</div>
        </div>
        <div>
          <div class="text-muted">Impostos</div>
          <div class="h5 mb-0 text-dark font-weight-bold">{{ summary_all.impostos|brl }}</div>
        </div>
        <div>
          <div class="text-muted">Líquido (calculado)</div>
          <div class="h5 mb-0 text-dark font-weight-bold">{{ summary_all.liquido_calculado|brl }}</div>
        </div>
        <div>
          <div class="text-muted">Líquido (informado)</div>
          <div class="h5 mb-0 text-dark font-weight-bold">{{ summary_all.liquido_informado|brl }}</div>
        </div>
        <div>
          <div class="text-muted">Diferença</div>
          <div class="h5 mb-0 font-weight-bold {% if summary_all.diferenca and summary_all.diferenca != 0 %}diff-highlight{% else %}text-dark{% endif %}">
            {{ summary_all.diferenca|brl }}
            {% if summary_all.diferenca and summary_all.diferenca != 0 and summary_all.percent_diferenca %}
              <small class="ml-1" style="font-weight:600;">({{ summary_all.percent_diferenca|pct }})</small>
            {% endif %}
          </div>
        </div>
        <div class="flex-break"></div>
        <div>
          <div class="text-muted">Taxa média de impostos</div>
          <div class="h5 mb-0 text-dark font-weight-bold">{% if summary_all.taxa_media_impostos %}{{ summary_all.taxa_media_impostos|pct }}{% else %}-{% endif %}</div>
        </div>
        <div>
          <div class="text-muted">Procedimento mais rentável</div>
          <div class="h6 mb-0 text-dark font-weight-bold">
            {% if summary_all.top_procedimento_nome %}
              {{ summary_all.top_procedimento_valor|brl }}
              <small class="text-muted d-block" style="max-width:280px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="{{ summary_all.top_procedimento_nome }}">{{ summary_all.top_procedimento_nome }}</small>
            {% else %}-{% endif %}
          </div>
        </div>
        <div>
          <div class="text-muted">Convênio mais rentável</div>
          <div class="h6 mb-0 text-dark font-weight-bold">
            {% if summary_all.top_convenio_nome %}
              {{ summary_all.top_convenio_valor|brl }}
              <small class="text-muted d-block">{{ summary_all.top_convenio_nome }}</small>
            {% else %}-{% endif %}
          </div>
        </div>
        <div>
          <div class="text-muted">Pior convênio (imposto sobre lucro)</div>
          <div class="h6 mb-0 text-dark font-weight-bold">
            {% if summary_all.worst_convenio_nome %}
              <span title="Lucro: {{ summary_all.worst_convenio_lucro|brl }} | Imposto: {{ summary_all.worst_convenio_imposto|brl }}">
                {{ summary_all.worst_convenio_nome }} —
                {% if summary_all.worst_convenio_percent %}
                  {{ summary_all.worst_convenio_percent|pct }}
                {% else %}-{% endif %}
              </span>
            {% else %}-{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <hr class="section-divider"/>
  <h5 class="mt-2">Por profissional</h5>

  <!-- Sumário com links para cada profissional + ações globais -->
  <div class="mb-3">
    <div class="small text-muted mb-2">Ir para:</div>
    <div>
      {% regroup entries by header.profissional_nome as prof_list %}
      {% for prof in prof_list %}
        {# Pega o primeiro entry para o id #}
        {% with entry=prof.list.0 %}
          <a class="btn btn-sm btn-outline-primary mr-1 mb-1" href="#prof-{{ entry.header.id }}">{{ prof.grouper }}</a>
        {% endwith %}
      {% endfor %}
    </div>
    <div class="mt-2">
      <button type="button" id="expand-all" class="btn btn-sm btn-outline-secondary mr-1">Expandir tudo</button>
      <button type="button" id="collapse-all" class="btn btn-sm btn-outline-secondary">Recolher tudo</button>
    </div>
  </div>

  {% for entry in entries %}
    {% with header=entry.header summary=entry.summary items=entry.items %}
    <div id="prof-{{ header.id }}" class="mb-4 p-3 border rounded" style="background:#fff; border-color:#e0e0e0;">
      <h5 class="d-flex align-items-center mb-2" style="gap:8px;">
        <span>{{ header.profissional_nome }}{% if header.especialidade %} — {{ header.especialidade }}{% endif %}</span>
        <button type="button" class="btn btn-sm btn-link ml-auto p-0" data-action="toggle-block" data-target="prof-body-{{ header.id }}" aria-expanded="true">Recolher</button>
      </h5>

      <div id="prof-body-{{ header.id }}">
      {% if summary %}
      <div class="row mb-3">
        <div class="col-12">
          <div class="border rounded p-3" style="background:#fff; border-color:#e0e0e0;">
            <div class="d-flex justify-content-between flex-wrap" style="gap:24px">
              <div>
                <div class="text-muted">Itens</div>
                <div class="h5 mb-0 text-dark font-weight-bold">{{ summary.count }}</div>
              </div>
              <div>
                <div class="text-muted">Qtd total</div>
                <div class="h5 mb-0 text-dark font-weight-bold">{{ summary.total_qtd|default:'0' }}</div>
              </div>
              <div>
                <div class="text-muted">Bruto</div>
                <div class="h5 mb-0 text-dark font-weight-bold">{{ summary.bruto|brl }}</div>
              </div>
              <div>
                <div class="text-muted">Impostos</div>
                <div class="h5 mb-0 text-dark font-weight-bold">{{ summary.impostos|brl }}</div>
              </div>
              <div>
                <div class="text-muted">Líquido (calculado)</div>
                <div class="h5 mb-0 text-dark font-weight-bold">{{ summary.liquido_calculado|brl }}</div>
              </div>
              <div>
                <div class="text-muted">Líquido (informado)</div>
                <div class="h5 mb-0 text-dark font-weight-bold">{{ summary.liquido_informado|brl }}</div>
              </div>
              <div>
                <div class="text-muted">Diferença</div>
                <div class="h5 mb-0 font-weight-bold {% if summary.diferenca and summary.diferenca != 0 %}diff-highlight{% else %}text-dark{% endif %}">
                  {{ summary.diferenca|brl }}
                  {% if summary.diferenca and summary.diferenca != 0 and summary.percent_diferenca %}
                    <small class="ml-1" style="font-weight:600;">({{ summary.percent_diferenca|pct }})</small>
                  {% endif %}
                </div>
              </div>
              <div class="flex-break"></div>
              <div>
                <div class="text-muted">Taxa média de impostos</div>
                <div class="h5 mb-0 text-dark font-weight-bold">{% if summary.taxa_media_impostos %}{{ summary.taxa_media_impostos|pct }}{% else %}-{% endif %}</div>
              </div>
              <div>
                <div class="text-muted">Procedimento mais rentável</div>
                <div class="h6 mb-0 text-dark font-weight-bold">
                  {% if summary.top_procedimento_nome %}
                    {{ summary.top_procedimento_valor|brl }}
                    <small class="text-muted d-block" style="max-width:280px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="{{ summary.top_procedimento_nome }}">{{ summary.top_procedimento_nome }}</small>
                  {% else %}-{% endif %}
                </div>
              </div>
              <div>
                <div class="text-muted">Convênio mais rentável</div>
                <div class="h6 mb-0 text-dark font-weight-bold">
                  {% if summary.top_convenio_nome %}
                    {{ summary.top_convenio_valor|brl }}
                    <small class="text-muted d-block">{{ summary.top_convenio_nome }}</small>
                  {% else %}-{% endif %}
                </div>
              </div>
              <div>
                <div class="text-muted">Pior convênio (imposto sobre lucro)</div>
                <div class="h6 mb-0 text-dark font-weight-bold">
                  {% if summary.worst_convenio_nome %}
                    <span title="Lucro: {{ summary.worst_convenio_lucro|brl }} | Imposto: {{ summary.worst_convenio_imposto|brl }}">
                      {{ summary.worst_convenio_nome }} —
                      {% if summary.worst_convenio_percent %}
                        {{ summary.worst_convenio_percent|pct }}
                      {% else %}-{% endif %}
                    </span>
                  {% else %}-{% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      {% if summary.alerts and summary.alerts|length %}
      <div class="row mb-3">
        <div class="col-12">
          <div class="border rounded p-3" style="background:#fff; border-color:#e0e0e0;">
            <div class="h6 mb-2">Insights</div>
            <ul class="mb-0">
              {% for a in summary.alerts %}
                <li class="mb-1">
                  {% if a.tipo == 'lucro_menor_que_imposto' %}
                    Convênio <strong>{{ a.convenio }}</strong>: lucro {{ a.lucro|brl }} menor que imposto {{ a.imposto|brl }} (dif {{ a.diferenca|brl }} {% if a.percent %} / {{ a.percent|pct }}{% endif %}).
                  {% elif a.tipo == 'lucro_quase_igual_imposto' %}
                    Convênio <strong>{{ a.convenio }}</strong>: lucro {{ a.lucro|brl }} quase igual ao imposto {{ a.imposto|brl }} (dif {{ a.diferenca|brl }} {% if a.percent %} / {{ a.percent|pct }}{% endif %}).
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% endif %}

      <h5>Itens</h5>
      <div class="table-responsive">
  <table class="table table-sm table-striped" data-prof-id="{{ header.id }}" data-prof-name="{{ header.profissional_nome }}" data-previsao="{{ header.previsao_pagamento }}">
          <thead>
            <tr>
              <th>Atendimento</th>
              <th>Data</th>
              <th>Paciente</th>
              <th>Convênio</th>
              <th>Categoria</th>
              <th>Código</th>
              <th>Procedimento</th>
              <th style="text-align:right;">Qtd</th>
              <th style="text-align:right;">Produzido</th>
              <th style="text-align:right;">Imposto</th>
              <th style="text-align:right;">Líquido</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
            <tr>
              <td>{{ it.atendimento }}</td>
              <td><span class="date-cell {% if it.data|is_older_than_days:60 %}text-danger{% endif %}">{{ it.data }}</span></td>
              <td>{{ it.paciente }}</td>
              <td>{{ it.convenio }}</td>
              <td>{{ it.categoria }}</td>
              <td>{{ it.codigo }}</td>
              <td>{{ it.procedimento }}</td>
              <td style="text-align:right;">{% if it.quantidade %}{{ it.quantidade|floatformat:2 }}{% endif %}</td>
              <td style="text-align:right;">{% if it.valor_produzido %}{{ it.valor_produzido|brl }}{% endif %}</td>
              <td style="text-align:right;">{% if it.imposto %}{{ it.imposto|brl }}{% endif %}</td>
              <td style="text-align:right;">{% if it.valor_liquido is not None %}{{ it.valor_liquido|brl }}{% else %}{{ it.valor_produzido|sub:it.imposto|brl }}{% endif %}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="11">Nenhum item importado.</td>
            </tr>
            {% endfor %}
          </tbody>
          {% if summary.count %}
          <tfoot>
            <tr class="totals-row">
              <th colspan="7" class="totals-label-master">Totais:</th>
              <th class="tfoot-cell text-right">
                <span class="tfoot-label">Qtd</span>
                <span class="tfoot-value">{{ summary.total_qtd|floatformat:0 }}</span>
              </th>
              <th class="tfoot-cell text-right">
                <span class="tfoot-label">Bruto</span>
                <span class="tfoot-value">{{ summary.bruto|brl }}</span>
              </th>
              <th class="tfoot-cell text-right">
                <span class="tfoot-label">Impostos</span>
                <span class="tfoot-value">{{ summary.impostos|brl }}</span>
              </th>
              <th class="tfoot-cell text-right">
                <span class="tfoot-label">Líquido</span>
                <span class="tfoot-value">{{ summary.liquido_informado|brl }}</span>
              </th>
            </tr>
          </tfoot>
          {% endif %}
        </table>
      </div>
      </div> <!-- /prof-body -->
    </div>
    {% endwith %}
  {% endfor %}

</div>

<style>
  /* Azul do cabeçalho da tabela e footer como no detalhe */
  .table thead th { background:#0D47A1 !important; color:#fff !important; border-bottom:3px solid #0B3C85 !important; font-weight:600; }
  .table thead th:first-child { border-top-left-radius:4px; }
  .table thead th:last-child { border-top-right-radius:4px; }
  tfoot .totals-row th { background:#fafafa; border-top:2px solid #0D47A1; vertical-align:top; }
  .totals-label-master { text-align:right; font-weight:600; padding-right:12px; }
  .tfoot-cell { min-width:120px; }
  .tfoot-label { display:block; font-size:11px; font-weight:500; color:#4b5563; text-transform:uppercase; letter-spacing:.5px; line-height:1.1; margin-bottom:2px; }
  .tfoot-value { display:block; font-weight:600; font-variant-numeric:tabular-nums; }
  .tfoot-cell .tfoot-value { white-space:nowrap; }
  table.table tfoot th, table.table tfoot td { padding-top:6px; padding-bottom:6px; }
  tfoot .totals-row th { line-height:1.1; }
  /* Refine per-column widths in footer: child(2)=Qtd, (3)=Bruto, (4)=Impostos, (5)=Líquido */
  tfoot .totals-row th:nth-child(2) { min-width: 90px; }
  tfoot .totals-row th:nth-child(3),
  tfoot .totals-row th:nth-child(4),
  tfoot .totals-row th:nth-child(5) { min-width: 140px; }
  .flex-break { flex-basis:100%; width:100%; height:0; }
  .diff-highlight { color:#F47C20 !important; }
  .recon-container { max-width: 1275px !important; }
  .section-divider { border-top:2px solid #e5e7eb; margin: 10px 0 16px; }
  
  /* Chat flutuante (mesma base do detalhe) */
  .qa-container { position: fixed; left: 20px; bottom: 20px; z-index: 1050; }
  .qa-fab { display:inline-flex; align-items:center; justify-content:center; width:60px; height:60px; padding:4px; background:#fff; border-radius:50%; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.2); position:relative; border:3px solid #0D47A1; }
  .qa-fab img { width:100%; height:100%; border-radius:50%; object-fit:contain; object-position:center center; background:#fff; }
  .assist-bubble { position:absolute; left:74px; bottom:6px; background:#2f2f2f; color:#fff; padding:12px 16px 14px; font-size:13px; line-height:1.25; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,.28); width:auto; max-width:none; opacity:0; transform:translateY(4px); pointer-events:none; transition:opacity .18s ease, transform .18s ease; display:inline-block; }
  .assist-bubble .assist-line1 { font-weight:500; white-space:nowrap; }
  .assist-bubble .assist-line2 { font-weight:600; white-space:nowrap; margin-top:4px; }
  .assist-bubble:before { content:""; position:absolute; left:-6px; top:22px; width:12px; height:12px; background:#2f2f2f; transform:rotate(45deg); border-radius:2px; }
  .qa-fab:hover .assist-bubble { opacity:1; transform:translateY(0); }
  .qa-window { width: 380px; max-height: 70vh; display:none; background:#fff; border-radius:16px 16px 0 0; box-shadow: 0 16px 40px rgba(0,0,0,.3); overflow:hidden; }
  .qa-header { display:flex; align-items:center; gap:12px; padding:12px 16px; background:linear-gradient(135deg,#0D47A1 0%,#0149b8 55%,#1e3a8a 100%); color:#fff; }
  .qa-header img { width:38px; height:38px; border-radius:50%; border:2px solid #0D47A1; outline:2px solid #fff; outline-offset:2px; object-fit:cover; object-position:center; background:#fff; box-shadow:0 0 0 1px rgba(255,255,255,.4); }
  .qa-header-text { display:flex; flex-direction:column; line-height:1.1; }
  .qa-header-text strong { font-size:15px; font-weight:600; }
  .qa-subtitle { font-size:12px; font-weight:400; opacity:.85; margin-top:2px; }
  .qa-close { margin-left:auto; cursor:pointer; opacity:.85; }
  .qa-body { height: 340px; overflow:auto; background:#f8fafc; padding:10px; }
  .qa-footer { padding:8px; border-top:1px solid #e5e7eb; background:#fff; }
  .qa-bubble { max-width:85%; padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; color:#111; overflow-wrap: anywhere; overflow: hidden; }
  /* Listas dentro do balão */
  .qa-bubble ul { list-style-type: disc; list-style-position: inside; padding-left: .5rem; margin: .25rem 0 .5rem; }
  .qa-bubble li { margin-left: 0; }
  .qa-row { display:flex; margin-bottom:8px; }
  .qa-row.user { justify-content: flex-end; }
  .qa-row.user .qa-bubble { background:#2563eb; color:#fff; border-color:#1d4ed8; }
  @media (max-width: 576px) { .qa-window { width: calc(100vw - 24px); } }
</style>

<script>
  (function(){
    function setBlockVisible(id, visible){
      var el = document.getElementById(id);
      if(!el) return;
      el.style.display = visible ? '' : 'none';
      // update button label
      var btn = document.querySelector('[data-action="toggle-block"][data-target="'+id+'"]');
      if(btn){ btn.textContent = visible ? 'Recolher' : 'Expandir'; btn.setAttribute('aria-expanded', String(visible)); }
    }
    // individual toggle
    document.addEventListener('click', function(e){
      var t = e.target;
      if(t && t.matches('[data-action="toggle-block"]')){
        var id = t.getAttribute('data-target');
        var el = document.getElementById(id);
        if(!el) return;
        var visible = el.style.display === 'none' ? false : true;
        setBlockVisible(id, !visible);
      }
    });
    // global controls
    var expandAll = document.getElementById('expand-all');
    var collapseAll = document.getElementById('collapse-all');
    if(expandAll){
      expandAll.addEventListener('click', function(){
        document.querySelectorAll('[id^="prof-body-"]').forEach(function(el){ setBlockVisible(el.id, true); });
      });
    }
    if(collapseAll){
      collapseAll.addEventListener('click', function(){
        document.querySelectorAll('[id^="prof-body-"]').forEach(function(el){ setBlockVisible(el.id, false); });
      });
    }
  })();
</script>

<!-- Chat consolidado (considera toda a página) -->
<div class="qa-container">
  <div id="qa-window" class="qa-window" aria-live="polite" aria-label="Chat GenIA">
    <div class="qa-header">
      <img src="{% static 'img/larissa-avatar.png' %}" alt="Larissa">
      <div class="qa-header-text">
        <strong>Larissa</strong>
        <span class="qa-subtitle">Assistente</span>
      </div>
      <span id="qa-close" class="qa-close" aria-label="Fechar">✕</span>
    </div>
    <div id="qa-messages" class="qa-body">
      <div class="qa-row">
        <div class="qa-bubble">Olá! Posso responder perguntas sobre este consolidado (todos os profissionais). Ex.: "Qual o líquido total?" ou "Qual convênio mais rentável?"</div>
      </div>
    </div>
    <div class="qa-footer">
      <form id="qa-form">
        <div class="input-group">
          <input type="text" class="form-control" id="qa-input" placeholder="Escreva sua pergunta..." autocomplete="off" required>
          <div class="input-group-append"><button class="btn btn-primary" type="submit">Enviar</button></div>
        </div>
      </form>
    </div>
  </div>
  <div id="qa-fab" class="qa-fab" role="button" aria-label="Abrir chat com GenIA" title="Abrir chat">
    <img id="qa-avatar" src="{% static 'img/larissa-avatar.png' %}?v=1" alt="Larissa" loading="lazy">
    <div id="assist-bubble" class="assist-bubble">
      <div class="assist-line1">Olá, precisa de ajuda?</div>
      <div class="assist-line2">Pergunte à <strong>Larissa!</strong></div>
    </div>
  </div>
</div>

<script>
(function(){
  // CSRF helper shared by AJAX calls on this page
  function getCSRFCookie(name){
    name = name || 'csrftoken';
    const cookies = document.cookie ? document.cookie.split(';') : [];
    for (let i = 0; i < cookies.length; i++){
      const c = cookies[i].trim();
      if (c.substring(0, name.length + 1) === (name + '=')){
        return decodeURIComponent(c.substring(name.length + 1));
      }
    }
    return '';
  }
  const idsCsv = '{{ header_ids|join:"," }}';
  const ids = idsCsv ? idsCsv.split(',').map(function(s){ return parseInt(s, 10); }) : [];
  const fab = document.getElementById('qa-fab');
  const win = document.getElementById('qa-window');
  const closeBtn = document.getElementById('qa-close');
  const form = document.getElementById('qa-form');
  const input = document.getElementById('qa-input');
  const msgs = document.getElementById('qa-messages');
  function scrollBottom(){ msgs.scrollTop = msgs.scrollHeight; }
  function show(){ win.style.display='block'; fab.style.display='none'; setTimeout(scrollBottom, 0); }
  function hide(){ win.style.display='none'; fab.style.display='inline-flex'; }
  function escapeHtml(s){ return s.replace(/[&<>]/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]); }); }
  function mdToHtml(md){
    // Pré-processa bullets inline do tipo " ... * item ... * item ..."
    md = md.replace(/\s\*\s+/g, '\n- ').replace(/\s•\s+/g, '\n- ');
    const fmtInline = function(s){
      return s
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1<\/strong>')
        .replace(/\*(.+?)\*/g, '<em>$1<\/em>');
    };
    const lines = md.split('\n');
    let out = '';
    let inList = false;
    for (let i = 0; i < lines.length; i++){
      const raw = lines[i];
      const esc = escapeHtml(raw);
      const m = esc.match(/^\s*[-*]\s+(.+)$/);
      if (m){
        if (!inList){ out += '<ul class="mb-2">'; inList = true; }
        out += '<li>' + fmtInline(m[1]) + '</li>';
      } else {
        if (inList){ out += '</ul>'; inList = false; }
        const trimmed = esc.trim();
        if (trimmed){ out += '<p class="mb-2">' + fmtInline(esc) + '</p>'; }
        else { out += '<br>'; }
      }
    }
    if (inList) out += '</ul>';
    return out;
  }
  fab.addEventListener('click', show);
  closeBtn.addEventListener('click', hide);
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const q = input.value.trim(); if(!q) return; input.value='';
    msgs.insertAdjacentHTML('beforeend', '<div class="qa-row user"><div class="qa-bubble">'+q.replace(/</g,'&lt;')+'</div></div>');
    scrollBottom();
    const id = 'ld_'+Date.now(); msgs.insertAdjacentHTML('beforeend', '<div id="'+id+'" class="qa-row"><div class="qa-bubble">Pensando...</div></div>');
    scrollBottom();
    try{
      const resp = await fetch("{% url 'qa_consolidated' %}", {
        method:'POST',
        headers:{ 'X-CSRFToken': getCSRFCookie() },
        body:new URLSearchParams({ q, ids: idsCsv })
      });
      const data = await resp.json();
      document.getElementById(id)?.remove();
      const text = (data && data.answer) ? data.answer : 'Não consegui responder agora.';
      msgs.insertAdjacentHTML('beforeend', '<div class="qa-row"><div class="qa-bubble">'+ mdToHtml(text) +'</div></div>');
    }catch(err){
      document.getElementById(id)?.remove();
      const text = 'Falha ao consultar a GenIA.';
      msgs.insertAdjacentHTML('beforeend', '<div class="qa-row"><div class="qa-bubble" style="background:#fff3cd;border-color:#ffe69c;">'+text+'</div></div>');
    }
    scrollBottom();
  });
})();
</script>

<!-- Dashboard Modal -->
<div id="dashboard-modal" class="dash-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="dash-title" style="display:none;">
  <div class="dash-backdrop" data-dash="close"></div>
  <div class="dash-dialog" role="document">
    <div class="dash-header">
      <h5 id="dash-title" class="mb-0">Dashboard — Visão geral</h5>
      <button type="button" class="dash-close" aria-label="Fechar" data-dash="close">✕</button>
    </div>
    <div class="dash-body">
      <div class="dash-grid">
        <div class="dash-card">
          <div class="dash-card-title">Top convênios por lucro</div>
          <div class="dash-chart" id="chart-convenios"></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-title">Top procedimentos por lucro</div>
          <div class="dash-chart" id="chart-procedimentos"></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-title">Top clientes por lucro (Top 3 / Bottom 3)</div>
          <div class="dash-chart" id="chart-clientes-lucro"></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-title">Top clientes por quantidade de procedimentos (Top 3 / Bottom 3)</div>
          <div class="dash-chart" id="chart-clientes-proc"></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-title">Distribuição por profissional (bruto)</div>
          <div class="dash-chart" id="chart-profissionais"></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-title">Prazo (45/60+ dias)</div>
          <div class="dash-chart" id="chart-prazos"></div>
        </div>
      </div>
    </div>
    <div class="dash-footer">
      <button type="button" class="btn btn-light" data-dash="close">Fechar</button>
    </div>
  </div>
  </div>

<style>
  .dash-modal { position: fixed; inset: 0; z-index: 1060; }
  .dash-backdrop { position:absolute; inset:0; background:rgba(0,0,0,.45); }
  .dash-dialog { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(1000px, 92vw); max-height:86vh; display:flex; flex-direction:column; background:#fff; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,.35); overflow:hidden; }
  .dash-header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; background:#0D47A1; color:#fff; }
  .dash-close { background:none; border:none; color:#fff; font-size:18px; line-height:1; cursor:pointer; opacity:.9; }
  .dash-close:hover { opacity:1; }
  .dash-body { padding:14px; overflow:auto; background:#f8fafc; }
  .dash-footer { padding:10px 14px; border-top:1px solid #e5e7eb; background:#fff; text-align:right; }
  .dash-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:14px; }
  .dash-card { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; }
  .dash-card-title { font-size:13px; font-weight:600; color:#374151; margin-bottom:8px; }
  .dash-chart { height:260px; display:flex; align-items:center; justify-content:center; color:#6b7280; border:1px dashed #e5e7eb; border-radius:8px; background:#fff; position:relative; overflow:hidden; }
  .dash-chart canvas { width:100% !important; height:100% !important; }
  @media (max-width: 768px){ .dash-grid { grid-template-columns: 1fr; } .dash-dialog { width: 94vw; } }
</style>

<script>
  (function(){
    const openBtn = document.getElementById('open-dashboard');
    const modal = document.getElementById('dashboard-modal');
    let chartsBuilt = false;
    function open(){
      modal.style.display='block';
      if(!chartsBuilt){ try { buildDashboardCharts(); chartsBuilt = true; } catch(e){ console.warn('Falha ao montar gráficos:', e); } }
    }
    function close(){ modal.style.display='none'; }
    if(openBtn){ openBtn.addEventListener('click', open); }
    modal?.addEventListener('click', function(e){ if(e.target && e.target.getAttribute('data-dash')==='close'){ close(); } });
    document.addEventListener('keydown', function(e){ if(e.key==='Escape' && modal && modal.style.display==='block'){ close(); } });
  })();
  // Gráficos serão preenchidos após alinharmos quais você deseja ver.
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    function buildReconSummary(s){
    const container = document.querySelector('.recon-container');
    const previsaoStr = container?.getAttribute('data-previsao') || '';
  const previsao = parseBRDate(previsaoStr);

    const rows = Array.from(document.querySelectorAll('[id^="prof-"] table tbody tr'));
    if(!rows.length){
      setPlaceholder('chart-convenios', 'Sem dados');
    }

  const byConvenio = new Map();
  const byProc = new Map();
  // Profissionais agrupados por id estável do header -> { name, total }
  const byProf = new Map();
  // Clientes
  const byClienteLucro = new Map();
  const byClienteCount = new Map();
    let prazoBuckets = { lt45:0, b45_60:0, gt60:0 };

    rows.forEach(tr => {
      const tds = tr.querySelectorAll('td');
      if(tds.length < 11) return;
      const dataStr = (tds[1].textContent || '').trim();
      const convenio = (tds[3].textContent || '').trim() || '(Sem convênio)';
      const proc = (tds[6].textContent || '').trim() || '(Sem procedimento)';
  const produzido = parseBRL((tds[8].textContent || '0')) || 0;
  const imposto = parseBRL((tds[9].textContent || '0')) || 0;
  const liquidoTxt = (tds[10].textContent || '').trim();
  const liquidoVal = liquidoTxt ? parseBRL(liquidoTxt) : null;
  const lucro = (typeof liquidoVal === 'number' && !isNaN(liquidoVal)) ? liquidoVal : (produzido - imposto);
  let bruto = produzido;
  if((!bruto || bruto === 0) && (typeof liquidoVal === 'number' && !isNaN(liquidoVal))){ bruto = liquidoVal + (imposto||0); }
  const rawCliente = (tds[2].textContent || '').trim();
  const cliente = rawCliente.replace(/\s+/g,' ').trim();

      // Profissional (médico)
  const table = tr.closest('table');
  let profName = (table && table.getAttribute('data-prof-name')) ? table.getAttribute('data-prof-name').trim() : 'Médico';
  let profId = (table && table.getAttribute('data-prof-id')) ? table.getAttribute('data-prof-id').trim() : '';
  // Normalização leve de nome (fallback quando não houver id)
  const profKey = profId || (profName ? profName.toLowerCase().replace(/\s+/g,' ').trim() : 'medico');

      // Acumular
  byConvenio.set(convenio, (byConvenio.get(convenio) || 0) + lucro);
  byProc.set(proc, (byProc.get(proc) || 0) + lucro);
  if(!byProf.has(profKey)) byProf.set(profKey, { name: profName, total: 0 });
  const agg = byProf.get(profKey); agg.total += bruto; byProf.set(profKey, agg);
  // Só acumula cliente quando o nome está presente (evita '(Sem cliente)')
  if(cliente && cliente !== '-' && cliente !== '—'){
    byClienteLucro.set(cliente, (byClienteLucro.get(cliente) || 0) + lucro);
    byClienteCount.set(cliente, (byClienteCount.get(cliente) || 0) + 1);
  }

      // Buckets de prazo com base na cor já aplicada na tabela (fonte da verdade visual)
      const dateSpan = tds[1].querySelector('.date-cell');
      if(dateSpan){
        if(dateSpan.classList.contains('text-danger')) prazoBuckets.gt60++;
        else if(dateSpan.classList.contains('text-orange')) prazoBuckets.b45_60++;
        else prazoBuckets.lt45++;
      } else {
        // Fallback: cálculo por datas (usa Previsão da tabela/médico; depois geral)
        const tblPrevStr = table ? table.getAttribute('data-previsao') : '';
        const prevDate = parseBRDate(tblPrevStr) || previsao;
        if (prevDate instanceof Date && !isNaN(prevDate) && dataStr) {
          const dItem = parseBRDate(dataStr);
          if(dItem instanceof Date && !isNaN(dItem)){
            const diffDays = Math.floor((prevDate - dItem) / (1000*60*60*24));
            if(diffDays > 60) prazoBuckets.gt60++;
            else if(diffDays >= 45 && diffDays <= 59) prazoBuckets.b45_60++;
            else if(diffDays >= 0 && diffDays < 45) prazoBuckets.lt45++;
          }
        }
      }
    });

    // Top 5 convenios e procedimentos
    const topConvenios = topN(byConvenio, 5);
    const topProcs = topN(byProc, 5);

    // Render charts
    renderBarChart('chart-convenios', 'Top convênios por lucro', topConvenios.labels, topConvenios.values);
    renderBarChart('chart-procedimentos', 'Top procedimentos por lucro', topProcs.labels, topProcs.values);

  // Profissionais: ordenar por valor desc
  const profArr = Array.from(byProf.values()).sort((a,b)=>b.total - a.total);
  renderPieChart('chart-profissionais', 'Distribuição por profissional (bruto)', profArr.map(x=>x.name), profArr.map(x=>round(x.total)));

  // Clientes Top/Bottom por lucro
  const tbLucro = topBottom6(byClienteLucro, true);
  renderBarChart('chart-clientes-lucro', 'Clientes por lucro (Top 3 / Bottom 3)', tbLucro.labels, tbLucro.values, true, tbLucro.colors);

  // Clientes Top/Bottom por quantidade de procedimentos
  const tbCount = topBottom6(byClienteCount, false);
  renderBarChartCounts('chart-clientes-proc', 'Clientes por quantidade (Top 3 / Bottom 3)', tbCount.labels, tbCount.values, true, tbCount.colors);

  // Prazos (barras laterais)
  const prazoLabels = ['Dentro do prazo (< 45 dias)', 'Entre 45 e 59 dias', 'Acima de 60 dias'];
  const prazoValues = [prazoBuckets.lt45, prazoBuckets.b45_60, prazoBuckets.gt60];
  renderBarChartCounts('chart-prazos', 'Pagamentos por faixa de prazo', prazoLabels, prazoValues, true, ['#10b981','#f59e0b','#ef4444']);
  }

  function parseBRL(txt){
    if(!txt) return 0;
    // Remove tudo exceto dígitos, vírgula e sinal
    let s = (''+txt).replace(/[^0-9,\-\.]/g, '');
    // Se houver pontos como milhar, remove-os; vírgula vira ponto decimal
    s = s.replace(/\./g, '').replace(/,/g, '.');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }
  function parseBRDate(txt){
    if(!txt) return null;
    const m = (''+txt).trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if(!m) return null;
    const d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10);
    const fullY = y < 100 ? (2000 + y) : y;
    const date = new Date(fullY, mo, d);
    return isNaN(date) ? null : date;
  }
  function topN(map, n){
    const arr = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0, n);
    return { labels: arr.map(x=>x[0]), values: arr.map(x=>round(x[1])) };
  }
  function sortMap(map){
    const arr = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
    return { labels: arr.map(x=>x[0]), values: arr.map(x=>round(x[1])) };
  }
  function round(v){ return Math.round((v + Number.EPSILON)*100)/100; }
  function setPlaceholder(id, text){
    const el = document.getElementById(id);
    if(el){ el.textContent = text; }
  }
  function ensureCanvas(id){
    const host = document.getElementById(id);
    if(!host) return null;
    host.innerHTML = '';
    const c = document.createElement('canvas');
    host.appendChild(c);
    return c.getContext('2d');
  }
  function renderBarChart(id, title, labels, values, horizontal=false, colors=null){
    const ctx = ensureCanvas(id); if(!ctx){ setPlaceholder(id, 'Sem dados'); return; }
    if(!labels.length){ setPlaceholder(id, 'Sem dados'); return; }
    const palette = (colors && colors.length===labels.length) ? colors : createColorPalette(labels.length);
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: title, data: values, backgroundColor: palette, borderColor: palette, borderWidth: 1, maxBarThickness: 42 }] },
      options: {
        indexAxis: horizontal ? 'y' : 'x',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, title: { display: false }, tooltip: { callbacks: { label: ctx => formatBRL(ctx.parsed[horizontal? 'x':'y']) } } },
        scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 6 } }, y: { beginAtZero: true } }
      }
    });
  }
  function renderDoughnutChart(id, title, labels, values){
    const ctx = ensureCanvas(id); if(!ctx){ setPlaceholder(id, 'Sem dados'); return; }
    const hasData = values.some(v=>v>0);
    if(!hasData){ setPlaceholder(id, 'Sem dados'); return; }
    new Chart(ctx, {
      type: 'doughnut',
      data: { labels, datasets: [{ data: values, backgroundColor: ['#10b981','#f59e0b','#ef4444'] }] },
      options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatBRL(ctx.parsed)}` } } } }
    });
  }
  function renderBarChartCounts(id, title, labels, values, horizontal=false, colors){
    const ctx = ensureCanvas(id); if(!ctx){ setPlaceholder(id, 'Sem dados'); return; }
    if(!labels.length){ setPlaceholder(id, 'Sem dados'); return; }
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: title, data: values, backgroundColor: colors && colors.length===values.length ? colors : '#2563eb' }] },
      options: {
        indexAxis: horizontal ? 'y' : 'x',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, title: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed[horizontal? 'x':'y'] || 0} itens` } } },
        scales: { x: { beginAtZero: true, ticks: { precision: 0 } }, y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  }
  function renderPieChart(id, title, labels, values){
    const ctx = ensureCanvas(id); if(!ctx){ setPlaceholder(id, 'Sem dados'); return; }
    const hasData = values.some(v=>v>0);
    if(!hasData){ setPlaceholder(id, 'Sem dados'); return; }
    const colors = createColorPalette(values.length);
    const total = values.reduce((a,b)=>a+b,0) || 1;
    new Chart(ctx, {
      type: 'pie',
      data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
      options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position: 'bottom', align: 'start', labels: { usePointStyle: true, pointStyle: 'rectRounded', boxWidth: 14, boxHeight: 10, padding: 14 } }, tooltip: { callbacks: { label: ctx => {
        const v = ctx.parsed || 0; const p = ((v/total)*100).toFixed(1).replace('.',','); return `${ctx.label}: ${formatBRL(v)} (${p}%)`;
      } } } } }
    });
  }
  function formatBRL(v){ try { return (typeof v==='number') ? v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' }) : String(v); } catch(e){ return String(v); } }
  function createColorPalette(n){
    const base = ['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#f97316','#eab308','#22c55e','#06b6d4'];
    if(n <= base.length) return base.slice(0,n);
    const out = [];
    for(let i=0;i<n;i++){
      out.push(`hsl(${Math.round((360/n)*i)}, 70%, 55%)`);
    }
    return out;
  }
  function topBottom6(map, isCurrency){
    const arr = Array.from(map.entries());
    if(!arr.length) return { labels: [], values: [], colors: [] };
    const top = arr.slice().sort((a,b)=>b[1]-a[1]).slice(0,3);
    const bottom = arr.slice().sort((a,b)=>a[1]-b[1]).slice(0,3);
    const merged = [...top, ...bottom];
    const labels = merged.map(x=>x[0]);
    const values = merged.map(x=> isCurrency ? round(x[1]) : Math.round(x[1]));
    const colors = merged.map((_,i)=> i<top.length ? '#10b981' : '#ef4444');
    return { labels, values, colors };
  }
</script>

<!-- Reconcile Modal -->
<div id="reconcile-modal" class="dash-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="reconcile-title" style="display:none;">
  <div class="dash-backdrop" data-rec="close"></div>
  <div class="dash-dialog" role="document" style="width:min(1100px, 95vw);">
    <div class="dash-header">
      <h5 id="reconcile-title" class="mb-0">Conciliação de Preços</h5>
      <button type="button" class="dash-close" aria-label="Fechar" data-rec="close">✕</button>
    </div>
    <div class="dash-body">
      <div id="reconcile-summary" class="mb-2">
        <div class="border rounded p-3" style="background:#fff; border-color:#e0e0e0;">
          <div class="text-muted small mb-0">Carregando...</div>
        </div>
      </div>
      <div class="d-flex align-items-center mb-2" style="gap:10px;">
        <div class="small text-muted mr-2">Filtros:</div>
        <label class="mb-0 small"><input type="checkbox" id="flt-diff" checked> Mostrar Diferenças</label>
        <label class="mb-0 small"><input type="checkbox" id="flt-missing" checked> Mostrar Sem Preço</label>
        <label class="mb-0 small"><input type="checkbox" id="flt-ok" checked> Mostrar OK</label>
      </div>
      <div class="table-responsive" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;">
        <table class="table table-sm table-striped" id="reconcile-table">
          <thead>
            <tr>
              <th>Convênio</th>
              <th>Código</th>
              <th>Categoria</th>
              <th class="text-right">Qtd</th>
              <th class="text-right">Produzido</th>
              <th class="text-right">Ref (unit.)</th>
              <th class="text-right">Ref (total)</th>
              <th class="text-right">Diferença</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="9">Carregando...</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="dash-footer">
      <button type="button" class="btn btn-light" data-rec="close">Fechar</button>
    </div>
  </div>
</div>

<script>
  (function(){
    const openBtn = document.getElementById('open-reconcile');
    const modal = document.getElementById('reconcile-modal');
    const tbody = modal.querySelector('#reconcile-table tbody');
    const summary = document.getElementById('reconcile-summary');
    function buildReconSummary(s){
      const itens = s.total || 0;
      const matched = s.matched || 0;
      const diff = s.diff || 0;
      const missing = s.missing || 0;
      return `
        <div class="border rounded p-3" style="background:#fff; border-color:#e0e0e0;">
          <div class="d-flex justify-content-between flex-wrap" style="gap:24px">
            <div>
              <div class="text-muted small">Itens</div>
              <div class="h5 mb-0 text-dark font-weight-bold">${itens}</div>
            </div>
            <div>
              <div class="text-muted small">Conciliados</div>
              <div class="h5 mb-0 text-dark font-weight-bold">${matched}</div>
            </div>
            <div>
              <div class="text-muted small">Com diferença</div>
              <div class="h5 mb-0 text-dark font-weight-bold">${diff}</div>
            </div>
            <div>
              <div class="text-muted small">Diferença (R$)</div>
              <div class="h5 mb-0 text-dark font-weight-bold">${fmt(s.diff_value_abs)}</div>
            </div>
            <div>
              <div class="text-muted small">Sem preço</div>
              <div class="h5 mb-0 text-dark font-weight-bold">${missing}</div>
            </div>
            <div>
              <div class="text-muted small">Sem preço (R$ prod.)</div>
              <div class="h5 mb-0 text-dark font-weight-bold">${fmt(s.missing_produced)}</div>
            </div>
          </div>
        </div>`;
    }
    // util helpers available in this scope
    const esc = (s)=> String(s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    const fmt = (v)=>{ if(v===null||v===undefined||v==='') return ''; try{ const n=parseFloat(v); if(isNaN(n)) return String(v); return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }catch(e){ return String(v);} };
    function getCSRFCookie(name){
      name = name || 'csrftoken';
      const cookies = document.cookie ? document.cookie.split(';') : [];
      for (let i = 0; i < cookies.length; i++){
        const c = cookies[i].trim();
        if (c.substring(0, name.length + 1) === (name + '=')){
          return decodeURIComponent(c.substring(name.length + 1));
        }
      }
      return '';
    }
    function open(){ modal.style.display='block'; }
    function close(){ modal.style.display='none'; }
    modal?.addEventListener('click', function(e){ if(e.target && e.target.getAttribute('data-rec')==='close'){ close(); } });
    document.addEventListener('keydown', function(e){ if(e.key==='Escape' && modal && modal.style.display==='block'){ close(); } });
    if(openBtn){
      openBtn.addEventListener('click', async function(){
        open();
        // Load reconciliation
        const idsCsv = '{{ header_ids|join:"," }}';
        tbody.innerHTML = '<tr><td colspan="9">Carregando...</td></tr>';
  summary.innerHTML = '<div class="border rounded p-3" style="background:#fff; border-color:#e0e0e0;"><div class="text-muted small mb-0">Carregando...</div></div>';
        try{
          const resp = await fetch('/reconciliation/consolidated/reconcile/', {
            method:'POST',
            headers:{ 'X-CSRFToken': getCSRFCookie() },
            body: new URLSearchParams({ ids: idsCsv })
          });
          // Try to parse JSON even on error to surface server error message
          const data = await resp.json();
          if(!resp.ok){ throw new Error(data && data.error ? data.error : 'Falha na conciliação'); }
          // Summary
          const s = data.summary || {};
          summary.innerHTML = buildReconSummary(s);
          // Rows
          const rows = data.rows || [];
          if(!rows.length){ tbody.innerHTML = '<tr><td colspan="9">Sem itens para conciliar.</td></tr>'; return; }
          const trHtml = rows.map(r=>{
            const cls = r.status==='ok' ? 'table-success' : (r.status==='diferenca' ? 'table-warning' : 'table-light');
            const codeCell = (r.price_id ? `<a href="/reconciliation/prices/${r.price_id}/edit/" target="_blank" title="Editar preço em nova aba">${esc(r.codigo)}</a>` : esc(r.codigo));
            return `<tr class="${cls}" data-status="${r.status}">
              <td>${esc(r.convenio)}</td>
              <td>${codeCell}</td>
              <td>${esc(r.categoria)}</td>
              <td class="text-right">${esc(r.qtd)}</td>
              <td class="text-right">${fmt(r.produzido)}</td>
              <td class="text-right">${fmt(r.ref_unit)}</td>
              <td class="text-right">${fmt(r.ref_total)}</td>
              <td class="text-right">${fmt(r.diff_total)}</td>
              <td>${r.status==='ok' ? 'OK' : (r.status==='diferenca' ? 'Diferença' : 'Sem preço')}</td>
            </tr>`;
          }).join('');
          tbody.innerHTML = trHtml;
          // apply filters on initial render
          applyFilters();
        }catch(err){
          tbody.innerHTML = `<tr><td colspan="9" class="text-danger">Falha ao conciliar: ${esc(err.message||err)}</td></tr>`;
          summary.innerHTML = '<div class="border rounded p-3" style="background:#fff; border-color:#e0e0e0;"><div class="text-danger small mb-0">Falha ao conciliar.</div></div>';
        }
      });
    }

    // Filter logic
    function applyFilters(){
      const showDiff = document.getElementById('flt-diff').checked;
      const showMissing = document.getElementById('flt-missing').checked;
      const showOk = document.getElementById('flt-ok').checked;
      tbody.querySelectorAll('tr').forEach(tr=>{
        const st = tr.getAttribute('data-status');
        if(!st){ tr.style.display=''; return; }
        let visible = false;
        if(st === 'diferenca' && showDiff) visible = true;
        if(st === 'sem-preco' && showMissing) visible = true;
        if(st === 'ok' && showOk) visible = true;
        tr.style.display = visible ? '' : 'none';
      });
    }
    ['flt-diff','flt-missing','flt-ok'].forEach(id=>{
      const el = document.getElementById(id);
      el?.addEventListener('change', applyFilters);
    });
  })();
</script>
{% endblock %}
